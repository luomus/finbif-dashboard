---
title: "LAJI.FI"
output: 
  flexdashboard::flex_dashboard:
    favicon: favicon.ico
    theme:
      version: 5
      fg: "#FDF7F7"
      bg: "#2C3E50"
      primary: "#1F74AD"
      base_font:
        google: Roboto
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: fill
runtime: shiny_prerendered
---

```{js, echo = FALSE}
document.querySelector(".navbar-header").innerHTML =
  '<a href="https://laji.fi" class="navbar-brand">LAJI.FI</a>'
```

```{r setup, context = "setup", include = FALSE}
library(DT)
library(finbif)
library(flexdashboard)
library(ggplot2)
library(httr2)
library(lubridate)
library(plotly)
library(scales)
library(shinyjs)
library(thematic)
library(waiter)

thematic_shiny(
  font = "Roboto", fg = "#FDF7F7", bg = "#2C3E50", accent = "#1F74AD"
)

api <- Sys.getenv("DASHBOARD_API")

req <- request(api)
```

```{r shinyjs, context = "render", echo = FALSE}
addResourcePath("shinyjs", system.file("srcjs", package = "shinyjs"))
```

```{r resources, context = "server"}
useShinyjs(html = TRUE)
```

<script src="shinyjs/inject.js"></script>

```{r waiter, context = "render", echo = FALSE}
addResourcePath("robots.txt", "robots.txt")
addResourcePath("favicon.ico", "favicon.ico")
autoWaiter(
  html = bs5_spinner(style = "spin", color = "secondary"),
  color = "transparent",
  fadeout = TRUE
)
```

Occurrence Data
================================================================================

Column {data-width=150}
--------------------------------------------------------------------------------

### {data-height=100}

```{r reset, context = "render", echo = FALSE}
actionButton("reset", "Reset", width = "100%", class = "btn-primary")
```

```{r reset_render, context = "server"}
observeEvent(
  input$reset,
  {
    reset("source")
    reset("taxa")
    reset("restriction")
    reset("collection_quality")
  }
)
```

### Data Sources {data-height=300}

```{r sources, context = "render", echo = FALSE}
selectInput(
  "source",
  NULL,
  c(
    "All Sources" = "NULL",
    "FinBIF" = "HR.1989",
    "Iisalmi Museum" = "HR.4911",
    "Kieppi, Kokkola Museum" = "HR.121",
    "Kuopio Museum" = "HR.1127",
    "Luke" = "HR.1915",
    "Luomus" = "HR.128",
    "Metsähallitus" = "HR.3551",
    "Porvoo Museum" = "HR.4171",
    "SYKE" = "HR.3552",
    "Tampere Museum" = "HR.3811",
    "University of Jyväskylä " = "HR.1247",
    "University of Oulu" = "HR.1207",
    "University of Turku" = "HR.1627"
  )
)
```

### Taxa {data-height=300}

```{r taxa, context = "render", echo = FALSE}
selectInput(
  "taxa",
  NULL,
  c(
    "All Taxa" = "NULL",
    "Algae" = "Algae",
    "Bryophytes" = "Bryophytes",
    "Vascular Plants",
    "Fungi & Lichen" = "Fungi and lichens",
    "Worms" = "Worms",
    "Molluscs" = "Molluscs",
    "Crustaceans" = "Crustaceans",
    "Myriapods" = "Myriapods",
    "Insects & Arachnids" = "Insects and arachnids",
    "Fish" = "Fishes",
    "Reptiles & Amphibians" = "Reptiles and amphibians",
    "Birds" = "Birds",
    "Mammals" = "Mammals"
  )
)
```

### Data Restriction {data-height=300}

```{r restriction, context = "render", echo = FALSE}
selectInput(
  "restriction",
  NULL,
  c(
    "All Data" = "NULL",
    "Restricted Only" = "true",
    "Unrestricted Only" = "false"
  )
)
```

Column {data-width=250}
--------------------------------------------------------------------------------

### Records

```{r fb_record_count_output, context = "render", echo = FALSE}
valueBoxOutput("record_count")
```

```{r fb_record_count_render, context = "server"}
record_count <-
  reactive({

    req_url_path(req, "record-count") |>
    req_url_query(
      restriction = input$restriction,
      taxa = input$taxa, 
      source = input$source
    ) |>
    req_perform() |>
    resp_body_raw() |>
    unserialize() |>
    valueBox(icon = "fa-pen", color = "#1F74AD")

  }) |>
  bindEvent(input$restriction, input$taxa, input$source)

output$record_count <- renderValueBox(record_count())
```

### Species

```{r fb_species_count_output, context = "render", echo = FALSE}
valueBoxOutput("species_count")
```

```{r fb_species_count_render, context = "server"}
species_count <-
  reactive({

    req_url_path(req, "species-count") |>
    req_url_query(
      restriction = input$restriction,
      taxa = input$taxa, 
      source = input$source
    ) |>
    req_perform() |>
    resp_body_raw() |>
    unserialize() |>
    valueBox(icon = "fa-dove", color = "#1F74AD")

  }) |>
  bindEvent(input$restriction, input$taxa, input$source)

output$species_count <- renderValueBox(species_count())
```

### Datasets

```{r fb_collection_count_output, context = "render", echo = FALSE}
valueBoxOutput("collection_count")
```

```{r fb_collection_count_render, context = "server"}
collection_count <-
  reactive({

    req_url_path(req, "collection-count") |>
    req_url_query(
      restriction = input$restriction,
      taxa = input$taxa, 
      source = input$source
    ) |>
    req_perform() |>
    resp_body_raw() |>
    unserialize() |>
    valueBox(icon = "fa-database", color = "#1F74AD")

  }) |>
  bindEvent(input$restriction, input$taxa, input$source)

output$collection_count <- renderValueBox(collection_count())
```

### Dataset Quality Level
</br>
```{r quality_table_output, context = "render", echo = FALSE}
selectInput(
  "collection_quality",
  NULL,
  c(
    "All Levels" = "NULL",
    "Professionals" = "professional",
    "Specialists" = "hobbyist",
    "Citizen Scientists" = "amateur"
  )
)

dataTableOutput("quality_table")
```

```{r quality_table_render, context = "server"}
quality_table <-
  reactive({

    req_url_path(req, "quality-table") |>
    req_url_query(
      collection_quality = input$collection_quality,
      restriction = input$restriction,
      taxa = input$taxa, 
      source = input$source
    ) |>
    req_perform() |>
    resp_body_raw() |>
    unserialize() |>
    datatable(
      rownames = FALSE,
      options = list(
        bPaginate = FALSE, searching = FALSE, info = FALSE, ordering = FALSE
      ),
      fillContainer = TRUE
    )

  }) %>%
  bindEvent(
    input$collection_quality, input$restriction, input$taxa, input$source
  )

output$quality_table <- renderDataTable(quality_table())
```

Column {data-width=600 .tabset .tabset-fade}
--------------------------------------------------------------------------------

### Occurrences

```{r occurrence_plot_output, context = "render", echo = FALSE}
plotlyOutput("occurrence_plot")
```

```{r occurrence_plot_render, context = "server"}
occurrence_plot <-
  reactive({

    p <-
      req_url_path(req, "occurrence-plot") |>
      req_url_query(
        restriction = input$restriction,
        taxa = input$taxa, 
        source = input$source
      ) |>
      req_perform() |>
      resp_body_raw() |>
      unserialize() |>
      mutate(
        Date = as_date(first_load_date), Records = cumsum(n_records)
      ) |>
      ggplot() +
        aes(x = Date, y = Records) +
        geom_line() +
        scale_y_continuous(label = comma) +
        labs(x = NULL, y = "Records")

    ggplotly(p)

  }) %>%
  bindEvent(input$restriction, input$taxa, input$source)

output$occurrence_plot <- renderPlotly(occurrence_plot())
```

### Annotations

```{r annotations_plot_output, context = "render", echo = FALSE}
plotlyOutput("annotations_plot")
```

```{r annotations_plot_render, context = "server"}
annotations_plot <-
  reactive({

    p <-
      req_url_path(req, "annotations-plot") |>
      req_url_query(
        restriction = input$restriction,
        taxa = input$taxa, 
        source = input$source
      ) |>
      req_perform() |>
      resp_body_raw() |>
      unserialize() |>
      mutate(Date = as_date(Date)) |>
      ggplot() +
        aes(x = Date, y = Annotations) +
        geom_line() +
        scale_y_continuous(label = comma) +
        labs(x = NULL, y = "Annotations")

    ggplotly(p)

  }) %>%
  bindEvent(input$restriction, input$taxa, input$source)

output$annotations_plot <- renderPlotly(annotations_plot())
```

Users
================================================================================

Column {data-width=600 .tabset}
--------------------------------------------------------------------------------

Column {data-width=400}
--------------------------------------------------------------------------------
