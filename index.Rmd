---
title: "Dashboard | LAJI.FI"
output: 
  flexdashboard::flex_dashboard:
    includes:
      in_header: [plausible.html, navbar.html]
    css: styles.css
    favicon: favicon.ico
    theme:
      version: 4
      fg: "#FDF7F7"
      bg: "#2C3E50"
      primary: "#2691D9"
      base_font:
        google: Roboto
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: fill
runtime: shiny_prerendered
---

```{r setup, context = "setup", include = FALSE}
library(bsplus)
library(dplyr)
library(DT)
library(flexdashboard)
library(future)
library(geofi)
library(ggplot2)
library(httr2)
library(lubridate)
library(plotly)
library(promises)
library(scales)
library(sf)
library(shiny.i18n)
library(shinyjs)
library(thematic)
library(waiter)

plan(multisession)

thematic_shiny(
  font = "Roboto", fg = "#FDF7F7", bg = "#2C3E50", accent = "#2691D9"
)

api <- Sys.getenv("DASHBOARD_API")

req <- request(api)

finland <- get_municipalities()

bio_province_zip <- "FI_FMNH_BGR_20161118.zip"

url <- "https://cdn.laji.fi/files/biogeographical-province/%s"

url <- sprintf(url, bio_province_zip)

download.file(url, bio_province_zip)

unzip(bio_province_zip, "FI_FMNH_BGR_20161118_3067.gml")

bio_provinces <- st_read("FI_FMNH_BGR_20161118_3067.gml")

source("collections.R")

enableBookmarking("url")

translator <- Translator$new(translation_json_path = "translation.json")
```

```{r shinyjs, context = "render", echo = FALSE}
addResourcePath("shinyjs", system.file("srcjs", package = "shinyjs"))
```

<script src="shinyjs/inject.js"></script>

```{js javascript, echo = FALSE}
document.querySelector(".navbar-header").innerHTML =
  '<a href="https://laji.fi" class="navbar-brand">LAJI.FI</a>'

$("body").on(
  "click",
  "a[href='#share-link']",
  function(e) {
    var url = window.location.href.split('#')[0];
    var hash = document.querySelector("a.nav-link.active").getAttribute("href");
    navigator.clipboard
      .writeText(url + hash)
      .then(() => {
        alert(
          "A link to the current dashboard has been copied to your clipboard"
        );
      })
      .catch(() => {
        alert("Error");
      });
  }
)

$("body").on(
  "click",
  "a[href='#en-lang']",
  function(e) {
    Shiny.setInputValue("lang_link", "en");
  }
)

$("body").on(
  "click",
  "a[href='#fi-lang']",
  function(e) {
    Shiny.setInputValue("lang_link", "fi");
  }
)

$("body").on(
  "shown.bs.tab",
  "a[href$='occ-plot']",
  function(e) {
    Shiny.setInputValue(
      "occurrence_tab_link", $(e.target).parent().index()
    );
  }
)

$("body").on(
  "shown.bs.tab",
  "a[href$='col-plot']",
  function(e) {
    Shiny.setInputValue(
      "collections_tab_link", $(e.target).parent().index()
    );
  }
)

$("body").on(
  "shown.bs.tab",
  "a[href$='cit-plot']",
  function(e) {
    Shiny.setInputValue(
      "citsci_tab_link", $(e.target).parent().index()
    );
  }
)
```

```{r resources, context = "server"}
useShinyjs(html = TRUE)

observe({

  inputs <- reactiveValuesToList(input)
  
  defaults <- c("", "NULL", "0", "maakunta_name_fi")
  
  inputs_with_default_values <-
    names(inputs)[unlist(inputs) %in% defaults]
  
  includes <- c(
    "lang",
    "source",
    "taxa",
    "restriction",
    "occurrence_tab",
    "collections_tab",
    "citsci_tab",
    "collection_quality",
    "level",
    "spec_source",
    "discipline",
    "spec_map_source",
    "map_discipline",
    "projects"
  )
  
  excluded_ids <- setdiff(names(inputs), includes)
  
  setBookmarkExclude(
    c(
      inputs_with_default_values,
      excluded_ids,
      ".clientValue-default-plotlyCrosstalkOpts"
    )
  )

  session$doBookmark()

}) |>
bindEvent(
  input$lang,
  input$source,
  input$taxa,
  input$restriction,
  input$occurrence_tab,
  input$collections_tab,
  input$citsci_tab,
  input$collection_quality,
  input$level,
  input$spec_source,
  input$discipline,
  input$spec_map_source,
  input$map_discipline,
  input$projects,
  ignoreInit = TRUE
)

onBookmarked({
  function(url) {
    updateQueryString(url)
    runjs('
      parent.location.hash = 
        document
          .querySelector("a.nav-link.active")
            .getAttribute("href");
    ')
  }
})

observe(
  updateSelectInput(session, "lang", selected = input[["lang_link"]])
) |>
bindEvent(input$lang_link)

observe(
  updateSelectInput(session, "source", selected = input[["source_link"]])
) |>
bindEvent(input$source_link, ignoreInit = TRUE)

observe(
  updateSelectInput(session, "taxa", selected = input[["taxa_link"]])
) |>
bindEvent(input$taxa_link, ignoreInit = TRUE)

observe(
  updateSelectInput(
    session, "restriction", selected = input[["restriction_link"]]
  )
) |>
bindEvent(input$restriction_link, ignoreInit = TRUE)
```

```{r waiter, context = "render", echo = FALSE}
addResourcePath("robots.txt", "robots.txt")
addResourcePath("favicon.ico", "favicon.ico")
autoWaiter(
  c(
    "quality_table", 
    "occurrence_plot",
    "species_plot",
    "annotations_plot",
    "datasets_plot",
    "municipality_map",
    "digitised_percent",
    "imaged_percent",
    "collection_plot",
    "progress_plot",
    "specimen_map", 
    "project_species_plot",
    "project_users_plot",
    "occurrence_cit_plot"
  ),
  html = spin_ring(),
  color = "transparent",
  fadeout = TRUE
)
```

`r textOutput("occurrence_title")` {#occurrence-page}
================================================================================

Column {data-width=150}
--------------------------------------------------------------------------------

### {data-height=250}

####

```{r occurrence_page_title_render, context = "server"}
occurrence_title <-
  reactive({
    translator$set_translation_language(input$lang)
    translator$t("Occurrence Data")
  })|>
  bindCache(input$lang, cache = "session") |>
  bindEvent(input$lang)

output$occurrence_title <- renderText(occurrence_title())
```

```{r occurrence_page_inputs, context = "render", echo = FALSE}
uiOutput("sources")
uiOutput("taxa")
uiOutput("restriction")
```

```{r source_render, context = "server"}
sources <- 
  reactive({
    
    translator$set_translation_language(input$lang)
    
    choices <- c("", "NULL", collections$sources)
    
    names(choices) <- c(
      paste0(translator$t("Data Source"), "   "),
      translator$t(c("All Sources", names(collections$sources)))
    )
  
    selectInput(
      "source_link",
      NULL,
      choices,
      input$source,
      width = "100%"
    )
    
  }) |>
  bindCache(input$lang, cache = "session") |>
  bindEvent(input$lang)

output$sources <- renderUI(sources())
```

```{r taxa_render, context = "server"}
taxa <- 
  reactive({
    
    translator$set_translation_language(input$lang)
    
    choices <- c(
      "",
      "NULL",
      "Algae",
      "Bryophytes",
      "Vascular Plants",
      "Fungi and lichens",
      "Worms",
      "Molluscs",
      "Crustaceans",
      "Myriapods",
      "Insects and arachnids",
      "Fishes",
      "Reptiles and amphibians",
      "Birds",
      "Mammals"
    )
    
    names(choices) <- c(
      paste0(translator$t("Taxa"), "   "),
      translator$t(
        c(
          "All Taxa",
          "Algae",
          "Bryophytes",
          "Vascular Plants",
          "Fungi & lichens",
          "Worms",
          "Molluscs",
          "Crustaceans",
          "Myriapods",
          "Insects & arachnids",
          "Fishes",
          "Reptiles & amphibians",
          "Birds",
          "Mammals"
        )
      )
    )
  
    selectInput(
      "taxa_link",
      NULL,
      choices,
      input$taxa,
      width = "100%"
    )

  }) |>
  bindCache(input$lang, cache = "session") |>
  bindEvent(input$lang)

output$taxa <- renderUI(taxa())
```

```{r restriction_render, context = "server"}
restriction <- 
  reactive({
    
    translator$set_translation_language(input$lang)
    
    choices <- c(
      "",
      "NULL",
      "true",
      "false"
    )
    
    names(choices) <- c(
      paste0(translator$t("Data Restriction"), "   "),
      translator$t(
        c(
          "All Data",
          "Restricted Only",
          "Unrestricted Only"
        )
      )
    )
    
    selectInput(
      "restriction_link",
      NULL,
      choices,
      input$restriction,
      width = "100%"
    )

  }) |>
  bindCache(input$lang, cache = "session") |>
  bindEvent(input$lang)

output$restriction <- renderUI(restriction())
```

####

```{r reset1, context = "render", echo = FALSE}
actionButton("reset1", "Reset", width = "100%", class = "btn-primary")
```

```{r reset_render1, context = "server"}
observe(
  {
    reset("source_link")
    reset("source")
    reset("taxa_link")
    reset("taxa")
    reset("restriction_link")
    reset("restriction")
    reset("collection_quality")
    reset("level")
  }
) |>
bindEvent(input$reset1)
```

#### {.invisible}

```{r hidden_inputs, context = "render", echo = FALSE}
selectInput("lang", NULL, choices = c("en", "fi"))
selectInput("occurrence_tab", NULL, choices = 0:3)
selectInput("collections_tab", NULL, choices = 0:1)
selectInput("citsci_tab", NULL, choices = 0:2)
selectInput("source", NULL, choices = c("", "NULL", collections$sources))
selectInput(
  "taxa",
  NULL,
  choices = c(
    "",
    "NULL",
    "Algae",
    "Bryophytes",
    "Vascular Plants",
    "Fungi and lichens",
    "Worms",
    "Molluscs",
    "Crustaceans",
    "Myriapods",
    "Insects and arachnids",
    "Fishes",
    "Reptiles and amphibians",
    "Birds",
    "Mammals"
  )
)
selectInput("restriction", NULL, choices = c("", "NULL", "true", "false"))
```

Column {data-width=200}
--------------------------------------------------------------------------------

### Records

```{r fb_record_count_output, context = "render", echo = FALSE}
valueBoxOutput("record_count")
```

```{r fb_record_count_render, context = "server"}
record_count <-
  reactive({

    req <-
      req_url_path(req, "record-count") |>
      req_url_query(
        restriction = input$restriction,
        taxa = input$taxa,
        source = input$source
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      valueBox(icon = "fa-pen", color = "#2691D9")

    }, seed = TRUE)

  }) |>
  bindCache(input$restriction, input$taxa, input$source, cache = "session") |>
  bindEvent(input$restriction, input$taxa, input$source)

output$record_count <- renderValueBox(record_count())
```

### Species

```{r fb_species_count_output, context = "render", echo = FALSE}
valueBoxOutput("species_count")
```

```{r fb_species_count_render, context = "server"}
species_count <-
  reactive({

    req <-
      req_url_path(req, "species-count") |>
      req_url_query(
        restriction = input$restriction,
        taxa = input$taxa, 
        source = input$source
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      valueBox(icon = "fa-dove", color = "#2691D9")

    }, seed = TRUE)

  }) |>
  bindCache(input$restriction, input$taxa, input$source, cache = "session") |>
  bindEvent(input$restriction, input$taxa, input$source)

output$species_count <- renderValueBox(species_count())
```

### Datasets

```{r fb_collection_count_output, context = "render", echo = FALSE}
valueBoxOutput("collection_count")
```

```{r fb_collection_count_render, context = "server"}
collection_count <-
  reactive({

    req <-
      req_url_path(req, "collection-count") |>
      req_url_query(
        restriction = input$restriction,
        taxa = input$taxa, 
        source = input$source
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      valueBox(icon = "fa-database", color = "#2691D9")

    }, seed = TRUE)

  }) |>
  bindCache(input$restriction, input$taxa, input$source, cache = "session") |>
  bindEvent(input$restriction, input$taxa, input$source)

output$collection_count <- renderValueBox(collection_count())
```

###

```{r quality_table_output, context = "render", echo = FALSE}
selectInput(
  "collection_quality",
  NULL,
  c(
    "Dataset Quality Level   " = "",
    "All Levels" = "NULL",
    "Professionals" = "professional",
    "Specialists" = "hobbyist",
    "Citizen Scientists" = "amateur"
  ),
  width = "100%"
)

dataTableOutput("quality_table")
```

```{r quality_table_render, context = "server"}
quality_table <-
  reactive({

    req <-
      req_url_path(req, "quality-table") |>
      req_url_query(
        collection_quality = input$collection_quality,
        restriction = input$restriction,
        taxa = input$taxa, 
        source = input$source
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize()

    }, seed = TRUE)

  }) |>
  bindCache(
    input$collection_quality, input$restriction, input$taxa, input$source,
    cache = "session"
  ) |>
  bindEvent(
    input$collection_quality, input$restriction, input$taxa, input$source
  )

output$quality_table <- renderDataTable({

  quality_table() %...>%
  datatable(
    rownames = FALSE,
    options = list(
      bPaginate = FALSE,
      searching = FALSE,
      info = FALSE,
      ordering = FALSE,
      processing = FALSE
    ),
    fillContainer = TRUE
  )

})
```

Column {#occurrence-data-plots data-width=250 .tabset .tabset-fade}
--------------------------------------------------------------------------------

```{r occurrence_plot_observers, context = "server"}
observeEvent(
  input$occurrence_tab_link,
  {
    updateSelectInput(
      session, 
      "occurrence_tab",
      selected = input[["occurrence_tab_link"]]
    )
  }
)

observe({
  
  removeCssClass(
    class = "active", selector = "#section-occurrence-data-plots li"
  )
  
  addCssClass(
    class = "active",
    selector = sprintf(
      "#section-occurrence-data-plots li:nth-child(%s)",
      as.integer(input$occurrence_tab) + 1L
    )
  )
  
})
```

### Occurrences {#occurrences-occ-plot}

```{r occurrence_plot_output, context = "render", echo = FALSE}
plotlyOutput("occurrence_plot")
```

```{r occurrence_plot_render, context = "server"}
occurrence_plot <-
  reactive({

    req <-
      req_url_path(req, "occurrence-plot") |>
      req_url_query(
        restriction = input$restriction,
        taxa = input$taxa, 
        source = input$source
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      mutate(Date = as_date(Date)) |>
      ggplot() +
        aes(x = Date, y = Records) +
        geom_line() +
        facet_wrap(~Type, 2) +
        scale_y_continuous(label = comma) +
        labs(x = NULL, y = NULL) +
        theme(plot.margin = unit(c(20, 0, 0, 10), "points"))

    }, seed = TRUE)

  }) |>
  bindCache(input$restriction, input$taxa, input$source, cache = "session") |>
  bindEvent(input$restriction, input$taxa, input$source)

output$occurrence_plot <- renderPlotly({

  occurrence_plot() %...>%
  ggplotly(dynamicTicks = TRUE)

})
```

### Species {#species-occ-plot}

```{r species_plot_output, context = "render", echo = FALSE}
plotlyOutput("species_plot")
```

```{r species_plot_render, context = "server"}
species_plot <-
  reactive({

    req <-
      req_url_path(req, "species-plot") |>
      req_url_query(
        restriction = input$restriction,
        taxa = input$taxa, 
        source = input$source
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      ggplot() +
        aes(Species, Records) +
        geom_bar(stat = "identity") +
        coord_flip() +
        labs(x = NULL, y = "Records")

    }, seed = TRUE)

  }) |>
  bindCache(input$restriction, input$taxa, input$source, cache = "session") |>
  bindEvent(input$restriction, input$taxa, input$source)

output$species_plot <- renderPlotly(

  species_plot() %...>%
  ggplotly(dynamicTicks = TRUE)

)
```

### Annotations {#annotations-occ-plot}

```{r annotations_plot_output, context = "render", echo = FALSE}
plotlyOutput("annotations_plot")
```

```{r annotations_plot_render, context = "server"}
annotations_plot <-
  reactive({

    req <-
      req_url_path(req, "annotations-plot") |>
      req_url_query(
        restriction = input$restriction,
        taxa = input$taxa, 
        source = input$source
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      mutate(Date = as_date(Date)) |>
      ggplot() +
        aes(x = Date, y = Annotations) +
        geom_line() +
        scale_y_continuous(label = comma) +
        labs(x = NULL, y = NULL)

    }, seed = TRUE)

  }) |>
  bindCache(input$restriction, input$taxa, input$source, cache = "session") |>
  bindEvent(input$restriction, input$taxa, input$source)

output$annotations_plot <- renderPlotly(

  annotations_plot() %...>%
  ggplotly(dynamicTicks = TRUE)

)
```

### Datasets {#datasets-occ-plot}

```{r datasets_plot_output, context = "render", echo = FALSE}
plotlyOutput("datasets_plot")
```

```{r datasets_plot_render, context = "server"}
datasets_plot <-
  reactive({

    req <-
      req_url_path(req, "datasets-plot") |>
      req_url_query(
        restriction = input$restriction,
        taxa = input$taxa, 
        source = input$source
      )
    
    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      ggplot() +
        aes(Dataset, n, fill = Type) +
        geom_bar(stat = "identity") +
        coord_flip() +
        scale_fill_viridis_d() +
        labs(x = NULL, y = NULL)

    }, seed = TRUE)

  }) |>
  bindCache(input$restriction, input$taxa, input$source, cache = "session") |>
  bindEvent(input$restriction, input$taxa, input$source)

output$datasets_plot <- renderPlotly({

  datasets_plot() %...>%
  ggplotly(dynamicTicks = TRUE) %...>%
  layout(
    legend = list(
      x = 0, xanchor = "left", yanchor = "bottom", orientation = "h"
    )
  )

})
```

Column {data-width=300}
--------------------------------------------------------------------------------

### 

```{r municipality_map_output, context = "render", echo = FALSE}
fillCol(
  height = "100%",
  flex = c(NA, 1),
  selectInput(
    "level",
    NULL,
    c(
      "Region" = "maakunta_name_fi",
      "Biogeographical Province" = "MAAKUNTA_FI",
      "Municipality" = "municipality_name_fi"
    ),
    width = "100%"
  ),
  plotlyOutput("municipality_map")
)
```

```{r municipality_map_render, context = "server"}
municipality_map <-
  reactive({

    level <- input$level

    endpoint <- switch(
      level, MAAKUNTA_FI = "bio-province-map", "municipality-map"
    )

    req <-
      req_url_path(req, endpoint) |>
      req_url_query(
        restriction = input$restriction,
        taxa = input$taxa, 
        source = input$source
      )

    future_promise({

      n <-
        req_perform(req) |>
        resp_body_raw() |>
        unserialize()

      map_data <-
        switch(
          level,
          MAAKUNTA_FI = left_join(bio_provinces, n, by = join_by(MAAKUNTA_FI)),
          left_join(finland, n, by = join_by(municipality_name_fi))
        )

      group_by(map_data, .data[[level]]) |>
      summarise(Records = sum(n_records, na.rm = TRUE)) |>
      mutate(text = paste0(.data[[level]], ": " , Records)) |>
      st_cast("MULTIPOLYGON") |>
      ggplot() +
        aes(fill = Records, text = text) +
        geom_sf(lwd = .1) +
        scale_fill_viridis_c(label = comma)

    }, seed = TRUE)

  }) |>
  bindCache(
    input$level, input$restriction, input$taxa, input$source, cache = "session"
  ) |>
  bindEvent(input$level, input$restriction, input$taxa, input$source)

output$municipality_map <- renderPlotly({

  municipality_map() %...>%
  ggplotly(tooltip = "text")

})
```

`r textOutput("specimen_collection_title")` {#specimen-collection-page}
================================================================================

Column {data-width=150}
--------------------------------------------------------------------------------

### {data-height=250}

####

```{r specimen_collection_page_title_render, context = "server"}
specimen_collection_title <-
  reactive({
    translator$set_translation_language(input$lang)
    translator$t("Specimen Collections/Digitisation")
  })|>
  bindCache(input$lang, cache = "session") |>
  bindEvent(input$lang)

output$specimen_collection_title <- renderText(specimen_collection_title())
```

```{r spec_sources1, context = "render", echo = FALSE}
selectInput(
  "spec_source",
  NULL,
  c(
    "Institution   " = "",
    "All Institutions" = "NULL",
    collections$institutions
  ),
  width = "100%"
)
selectInput(
  "discipline",
  NULL,
  c(
    "Discipline   " = "",
    "All Disciplines" = "NULL",
    "Botany" = "is_botany",
    "Zoology" = "is_zoology",
    "Geology" = "is_geology"
  ),
  width = "100%"
)
```

####

```{r reset2, context = "render", echo = FALSE}
actionButton("reset2", "Reset", width = "100%", class = "btn-primary")
```

```{r reset_render2, context = "server"}
observeEvent(
  input$reset2,
  {
    reset("spec_source")
    reset("discipline")
  }
)
```

Column {data-width=200}
--------------------------------------------------------------------------------

### Specimens

```{r fb_specimen_count_output, context = "render", echo = FALSE}
valueBoxOutput("specimen_count")
```

```{r fb_specimen_count_render, context = "server"}
specimen_count <-
  reactive({

    req <-
      req_url_path(req, "specimen-collections") |>
      req_url_query(
        discipline = input$discipline,
        spec_source = input$spec_source
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      valueBox(icon = "fa-mosquito", color = "#2691D9")

    }, seed = TRUE)

  }) |>
  bindCache(input$discipline, input$spec_source, cache = "session") |>
  bindEvent(input$discipline, input$spec_source)

output$specimen_count <- renderValueBox(specimen_count())
```

### Digitised

```{r fb_digitised_count_output, context = "render", echo = FALSE}
valueBoxOutput("digitised_count")
```

```{r fb_digitised_count_render, context = "server"}
digitised_count <-
  reactive({

    req <-
      req_url_path(req, "specimen-collections") |>
      req_url_query(
        discipline = input$discipline,
        spec_source = input$spec_source,
        stat = "n_specimens_digitised"
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      valueBox(icon = "fa-computer", color = "#2691D9")

    }, seed = TRUE)

  }) |>
  bindCache(input$discipline, input$spec_source, cache = "session") |>
  bindEvent(input$discipline, input$spec_source)

output$digitised_count <- renderValueBox(digitised_count())
```

### Percent Digitised

```{r fb_digitised_percent_output, context = "render", echo = FALSE}
gaugeOutput("digitised_percent")
```

```{r fb_digitised_percent_render, context = "server"}
digitised_percent <-
  reactive({

    req <-
      req_url_path(req, "specimen-collections") |>
      req_url_query(
        discipline = input$discipline,
        spec_source = input$spec_source,
        stat = "percent_digitised"
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      gauge(min = 0, max = 100, symbol = "%")

    }, seed = TRUE)

  }) |>
  bindCache(input$discipline, input$spec_source, cache = "session") |>
  bindEvent(input$discipline, input$spec_source)

output$digitised_percent <- renderGauge(digitised_percent())
```

### Imaged

```{r fb_imaged_count_output, context = "render", echo = FALSE}
valueBoxOutput("imaged_count")
```

```{r fb_imaged_count_render, context = "server"}
imaged_count <-
  reactive({

    req <-
      req_url_path(req, "specimen-collections") |>
      req_url_query(
        discipline = input$discipline,
        spec_source = input$spec_source,
        stat = "n_specimens_imaged"
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      valueBox(icon = "fa-camera", color = "#2691D9")

    }, seed = TRUE)

  }) |>
  bindCache(input$discipline, input$spec_source, cache = "session") |>
  bindEvent(input$discipline, input$spec_source)

output$imaged_count <- renderValueBox(imaged_count())
```

### Percent Imaged

```{r fb_imaged_percent_output, context = "render", echo = FALSE}
gaugeOutput("imaged_percent")
```

```{r fb_imaged_percent_render, context = "server"}
imaged_percent <-
  reactive({

    req <-
      req_url_path(req, "specimen-collections") |>
      req_url_query(
        discipline = input$discipline,
        spec_source = input$spec_source,
        stat = "percent_imaged"
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      gauge(min = 0, max = 100, symbol = "%")

    }, seed = TRUE)

  }) |>
  bindCache(input$discipline, input$spec_source, cache = "session") |>
  bindEvent(input$discipline, input$spec_source)

output$imaged_percent <- renderGauge(imaged_percent())
```

Column {#collection-data-plots data-width=550 .tabset .tabset-fade}
--------------------------------------------------------------------------------

```{r collections_plot_observers, context = "server"}
observeEvent(
  input$collections_tab_link,
  {
    updateSelectInput(
      session, 
      "collections_tab",
      selected = input[["collections_tab_link"]]
    )
  }
)

observe({
  
  removeCssClass(
    class = "active", selector = "#section-collection-data-plots li"
  )
  
  addCssClass(
    class = "active",
    selector = sprintf(
      "#section-collection-data-plots li:nth-child(%s)",
      as.integer(input$collections_tab) + 1L
    )
  )
  
})
```

### Collections {#collections-col-plot}

```{r collection_plot_output, context = "render", echo = FALSE}
plotlyOutput("collection_plot")
```

```{r collection_plot_render, context = "server"}
collection_plot <-
  reactive({

    req <-
      req_url_path(req, "specimen-collections") |>
      req_url_query(
        discipline = input$discipline,
        spec_source = input$spec_source,
        stat = "table"
      )
    
    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      ggplot() +
        aes(Collection, n, fill = Status) +
        geom_bar(stat = "identity") +
        coord_flip() +
        scale_fill_viridis_d() +
        labs(x = NULL, y = "Specimens")

    }, seed = TRUE)

  }) |>
  bindCache(input$discipline, input$spec_source, cache = "session") |>
  bindEvent(input$discipline, input$spec_source)

output$collection_plot <- renderPlotly({

  collection_plot() %...>%
  ggplotly(dynamicTicks = TRUE) %...>%
  layout(
    legend = list(
      x = 0, xanchor = "left", yanchor = "bottom", orientation = "h"
    )
  )

})
```

### Progress {#progress-col-plot}

```{r progress_plot_output, context = "render", echo = FALSE}
plotlyOutput("progress_plot")
```

```{r progress_plot_render, context = "server"}
progress_plot <-
  reactive({

    req <-
      req_url_path(req, "progress-plot") |>
      req_url_query(
        discipline = input$discipline,
        spec_source = input$spec_source
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      mutate(Date = as_date(Date)) |>
      ggplot() +
        aes(x = Date, y = Specimens) +
        geom_line() +
        facet_wrap(~Status, 2) +
        scale_y_continuous(label = comma) +
        labs(x = NULL, y = NULL) +
        theme(plot.margin = unit(c(20, 0, 0, 10), "points"))

    }, seed = TRUE)

  }) |>
  bindCache(input$discipline, input$spec_source, cache = "session") |>
  bindEvent(input$discipline, input$spec_source)

output$progress_plot <- renderPlotly({

  progress_plot() %...>%
  ggplotly(dynamicTicks = TRUE)

})
```

`r textOutput("specimen_map_title")` {#specimen-map-page}
================================================================================

Column {data-width=150}
--------------------------------------------------------------------------------

### {data-height=250}

####

```{r specimen_map_page_title_render, context = "server"}
specimen_map_title <-
  reactive({
    translator$set_translation_language(input$lang)
    translator$t("Specimens Map")
  })|>
  bindCache(input$lang, cache = "session") |>
  bindEvent(input$lang)

output$specimen_map_title <- renderText(specimen_map_title())
```

```{r spec_sources2, context = "render", echo = FALSE}
selectInput(
  "spec_map_source",
  NULL,
  c(
    "Institution   " = "",
    "All Institutions" = "NULL",
    collections$institutions
  ),
  width = "100%"
)
selectInput(
  "map_discipline",
  NULL,
  c(
    "Discipline   " = "",
    "All Disciplines" = "NULL",
    "Botany" = "is_botany",
    "Zoology" = "is_zoology",
    "Geology" = "is_geology"
  ),
  width = "100%"
)
```

####

```{r reset3, context = "render", echo = FALSE}
actionButton("reset3", "Reset", width = "100%", class = "btn-primary")
```

```{r reset_render3, context = "server"}
observeEvent(
  input$reset3,
  {
    reset("spec_map_source")
    reset("map_discipline")
  }
)
```

Column {data-width=750}
--------------------------------------------------------------------------------

###

```{r specimen_map_output, context = "render", echo = FALSE}
fillCol(plotlyOutput("specimen_map"))
```

```{r specimen_map_render, context = "server"}
specimen_map <-
  reactive({

    req <- 
      req_url_path(req, "specimen-map") |>
      req_url_query(
        discipline = input$map_discipline,
        spec_source = input$spec_map_source
      )

    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      ggplot() +
        aes(fill = Specimens, text = text) +
        geom_sf(lwd = .1) +
        scale_fill_viridis_c(label = comma, trans = "pseudo_log")

    }, seed = TRUE)

  }) |>
  bindCache(input$map_discipline, input$spec_map_source, cache = "session") |>
  bindEvent(input$map_discipline, input$spec_map_source)

output$specimen_map <- renderPlotly({

  specimen_map() %...>%
  ggplotly(tooltip = "text")

})
```

`r textOutput("citsci_title")` {#citsci-page}
================================================================================

Column {data-width=150}
--------------------------------------------------------------------------------

### {data-height=250}

####

```{r citsci_title_render, context = "server"}
citsci_title <-
  reactive({
    translator$set_translation_language(input$lang)
    translator$t("Citizen Science")
  })|>
  bindCache(input$lang, cache = "session") |>
  bindEvent(input$lang)

output$citsci_title <- renderText(citsci_title())
```

```{r projects, context = "render", echo = FALSE}
selectInput(
  "projects",
  NULL,
  c(
    "Project   " = "",
    "All Projects" = "NULL",
    collections$cit_sci_projects
  ),
  width = "100%"
)
```

####

```{r reset4, context = "render", echo = FALSE}
actionButton("reset4", "Reset", width = "100%", class = "btn-primary")
```

```{r reset_render4, context = "server"}
observeEvent(
  input$reset4,
  {
    reset("projects")
  }
)
```

Column {data-width=200}
--------------------------------------------------------------------------------

### Projects

```{r fb_project_count_output, context = "render", echo = FALSE}
valueBoxOutput("project_count")
```

```{r fb_project_count_render, context = "server"}
project_count <-
  reactive({

    n <- length(collections$cit_sci_projects)

    caption <- "Projects"

    if (!input$projects %in% c("", "NULL")) {
  
      n <- 1L

      caption <- "Project"

    }

    future_promise({

      valueBox(
        n, icon = "fa-clipboard-list", color = "#2691D9", caption = caption
      )

    }, seed = TRUE)

  }) |>
  bindCache(input$projects, cache = "session") |>
  bindEvent(input$projects)

output$project_count <- renderValueBox(project_count())
```

Column {#citsci-data-plots data-width=550 .tabset .tabset-fade}
--------------------------------------------------------------------------------

```{r citsci_data_plot_observers, context = "server"}
observeEvent(
  input$citsci_tab_link,
  {
    updateSelectInput(
      session, 
      "citsci_tab",
      selected = input[["citsci_tab_link"]]
    )
  }
)

observe({
  
  removeCssClass(
    class = "active", selector = "#section-citsci-data-plots li"
  )
  
  addCssClass(
    class = "active",
    selector = sprintf(
      "#section-citsci-data-plots li:nth-child(%s)",
      as.integer(input$citsci_tab) + 1L
    )
  )
  
})
```

### Species {#species-cit-plot}

```{r project_species_plot_output, context = "render", echo = FALSE}
plotlyOutput("project_species_plot")
```

```{r project_species_plot_render, context = "server"}
project_species_plot <-
  reactive({

    req <-
      req_url_path(req, "cit-sci-species-count") |>
      req_url_query(projects = input$projects)
    
    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      ggplot() +
        aes(Year, Species) +
        geom_bar(stat = "identity")

    }, seed = TRUE)

  }) |>
  bindCache(input$projects, cache = "session") |>
  bindEvent(input$projects)

output$project_species_plot <- renderPlotly({

  project_species_plot() %...>%
  ggplotly()

})
```

### Users {#users-cit-plot}

```{r project_users_plot_output, context = "render", echo = FALSE}
plotlyOutput("project_users_plot")
```

```{r project_users_plot_render, context = "server"}
project_users_plot <-
  reactive({

    req <-
      req_url_path(req, "cit-sci-user-count") |>
      req_url_query(projects = input$projects)
    
    future_promise({

      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      ggplot() +
        aes(Year, Users) +
        geom_bar(stat = "identity")

    }, seed = TRUE)

  }) |>
  bindCache(input$projects, cache = "session") |>
  bindEvent(input$projects)

output$project_users_plot <- renderPlotly({

  project_users_plot() %...>%
  ggplotly()

})
```

### Occurrences {#occurrences-cit-plot}

```{r occurrence_cit_plot_output, context = "render", echo = FALSE}
plotlyOutput("occurrence_cit_plot")
```

```{r occurrence_cit_plot_render, context = "server"}
occurrence_cit_plot <-
  reactive({
    
    req <-
      req_url_path(req, "occurrence_citsci") |>
      req_url_query(projects = input$projects)
    
    future_promise({
      
      req_perform(req) |>
      resp_body_raw() |>
      unserialize() |>
      ggplot() +
        aes(Project, Occurrences) +
        geom_bar(stat = "identity") +
        coord_flip() +
        labs(x = NULL, y = "Occurrences")

    }, seed = TRUE)
    
  }) |>
  bindCache(input$projects, cache = "session") |>
  bindEvent(input$projects)

output$occurrence_cit_plot <- renderPlotly({
  
  occurrence_cit_plot() %...>%
    ggplotly(dynamicTicks = TRUE)
  
})
```
