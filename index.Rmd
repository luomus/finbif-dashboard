---
title: "LAJI.FI"
output: 
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      fg: "#FDF7F7"
      bg: "#2C3E50"
      primary: "#1F74AD"
      base_font:
        google: Roboto
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{js, echo = FALSE}
document.querySelector(".navbar-header").innerHTML =
  '<a href="https://laji.fi" class="navbar-brand">LAJI.FI</a>'
```

```{r setup, include = FALSE}
library(flexdashboard)
library(finbif)
library(ggplot2)
library(plotly)
library(scales)
library(dplyr)
library(tidyr)
library(janitor)
library(lubridate)
library(DT)

thematic::thematic_shiny(
  font = "Roboto", fg = "#FDF7F7", bg = "#2C3E50", accent = "#1F74AD"
)

options(
  finbif_use_cache = 0.05,
  finbif_hide_progress = TRUE,
  finbif_rate_limit = Inf,
  finbif_max_page_size = 3000
)

if (Sys.getenv("BRANCH") != "main") {

  options(finbif_api_url = "https://apitest.laji.fi")

}

filter <- list(
  quality_issues = "both",
  record_reliability = c("reliable", "unassessed", "unreliable"),
  record_quality = c(
    "expert_verified", "community_verified", "unassessed", "uncertain",
    "erroneous"
  )
)
```

Occurrence Data
================================================================================

Column {data-width=150}
--------------------------------------------------------------------------------

### Data Restriction

```{r inputs}
selectInput(
  "restriction",
  NULL,
  c("All Data" = " ", "Restricted Only" = "true", "Unrestricted Only" = "false")
)
```

Column {data-width=250}
--------------------------------------------------------------------------------

### Records

```{r fb_record_count}
renderValueBox({

  filter <- c(filter, list(restricted = input$restriction))

  valueBox(
    fb_occurrence(filter = filter, select = "record_id", count_only = TRUE),
    icon = "fa-pen", color = "#1F74AD"
  )
})
```

### Species

```{r fb_species_count}
renderValueBox({

  filter <- c(filter, list(restricted = input$restriction))

  valueBox(
    fb_occurrence(
      filter = filter, select = "species_scientific_name",
      aggregate = "records", count_only = TRUE
    ),
    icon = "fa-dove", color = "#1F74AD"
  )
})
```

### Datasets

```{r fb_collection_count}
renderValueBox({

  filter <- c(filter, list(restricted = input$restriction))

  valueBox(
    fb_occurrence(
      filter = filter, select = "collection_id", aggregate = "records",
      count_only = TRUE
    ),
    icon = "fa-database", color = "#1F74AD"
  )
})
```

### Collection Quality
</br>
```{r professional}
selectInput(
  "collection_quality",
  NULL,
  c(
    "Professionals" = "professional", "Specialists" = "hobbyist",
    "Citizen Scientists" = "amateur"
  )
)

renderDataTable(
  {

    filter <- c(filter, list(restricted = input$restriction))

    fb_occurrence(
      filter = c(filter, list(collection_quality = input$collection_quality)),
      select = c(Quality = "record_quality"), aggregate = "records", n = "all"
    ) |>
    mutate(record_quality = replace_na(Quality, "Unnassesed")) |>
    group_by(Quality) |>
    summarise(n_records = sum(n_records), .groups = "drop") |>
    rename(Count = n_records) |>
    mutate(
      Quality = factor(
        Quality,
        levels = c(
          "Expert verified", "Community verified", "Unassessed", "Uncertain",
          "Erroneous"
        ),
        ordered = TRUE
      )
    ) |>
    arrange(Quality) |>
    adorn_totals() |>
    datatable(
      rownames = FALSE,
      options = list(bPaginate = FALSE, searching = FALSE, info = FALSE),
      fillContainer = TRUE
    )
  }
)
```

Column {data-width=600 .tabset .tabset-fade}
--------------------------------------------------------------------------------

### Occurrences

```{r occurrence-data}
renderPlotly({

  filter <- c(filter, list(restricted = input$restriction))

  p <- fb_occurrence(
    filter = filter, select = "first_load_date", aggregate = "records",
    n = "all"
  ) |>
  arrange(first_load_date) |>
  mutate(Date = as.Date(first_load_date), Records = cumsum(n_records)) |>
  ggplot() +
  aes(x = Date, y = Records) +
  geom_line() +
  scale_y_continuous(label = comma) +
  labs(x = NULL, y = "Records")
  ggplotly(p)
})
```

### Annotations

```{r annotations}
renderPlotly({

  filter <- c(filter, list(restricted = input$restriction))
  
  n <- 500

  n_annotations <- fb_occurrence(
    filter = c(filter, list(annotated = TRUE)),
    select = "record_annotation_created",
    sample = TRUE, n = n
  )

  Date <- n_annotations[["record_annotation_created"]]
  Date <- unlist(Date)
  Date <- sort(Date)
  Date <- as_datetime(Date)
  Date <- as.Date(Date)

  total_annotations <- attr(n_annotations, "nrec_avl")

  Annotations <- length(Date)

  mult <- total_annotations / n

  Annotations <- seq_len(Annotations)

  Annotations <- as.integer(Annotations * mult)

  p <- ggplot() +
    aes(x = Date, y = Annotations) +
    geom_line() +
    scale_y_continuous(label = comma) +
    labs(x = NULL, y = "Annotations")

  ggplotly(p)

})
```

Users
================================================================================

Column {data-width=600 .tabset}
--------------------------------------------------------------------------------

Column {data-width=400}
--------------------------------------------------------------------------------
