---
title: "LAJI.FI"
output: 
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      fg: "#FDF7F7"
      bg: "#2C3E50"
      primary: "#1F74AD"
      base_font:
        google: Roboto
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{js, echo = FALSE}
document.querySelector(".navbar-header").innerHTML =
  '<a href="https://laji.fi" class="navbar-brand">LAJI.FI</a>'
```

```{r setup, include = FALSE}
library(DT)
library(finbif)
library(flexdashboard)
library(httr2)
library(plotly)
library(thematic)

thematic_shiny(
  font = "Roboto", fg = "#FDF7F7", bg = "#2C3E50", accent = "#1F74AD"
)

options(
  finbif_use_cache = 0.05,
  finbif_cache_offset = .5,
  finbif_hide_progress = TRUE,
  finbif_rate_limit = Inf,
  finbif_max_page_size = 3000L,
  finbif_use_async = FALSE
)

op <- options()

sanitise <- function(x) {

  switch(x, `NULL` = NULL, x)

}

base_filter <- list(
  quality_issues = "both",
  record_reliability = c(
    "reliable",
    "unassessed",
    "unreliable"
  ),
  record_quality = c(
    "expert_verified",
    "community_verified",
    "unassessed",
    "uncertain",
    "erroneous"
  )
)

api <- Sys.getenv("DASHBOARD_API")

req <- request(api)
```

Occurrence Data
================================================================================

Column {data-width=150}
--------------------------------------------------------------------------------

### Data Sources

```{r sources}
selectInput(
  "source",
  NULL,
  c(
    "All Sources" = "NULL",
    "FinBIF" = "HR.1989",
    "Iisalmi Museum" = "HR.4911",
    "Kieppi, Kokkola Museum" = "HR.121",
    "Kuopio Museum" = "HR.1127",
    "Luke" = "HR.1915",
    "Luomus" = "HR.128",
    "Metsähallitus" = "HR.3551",
    "Porvoo Museum" = "HR.4171",
    "SYKE" = "HR.3552",
    "Tampere Museum" = "HR.3811",
    "University of Jyväskylä " = "HR.1247",
    "University of Oulu" = "HR.1207",
    "University of Turku" = "HR.1627"
  )
)
```

### Taxa

```{r taxa}
selectInput(
  "taxa",
  NULL,
  c(
    "All Taxa" = "NULL",
    "Algae" = "Algae",
    "Bryophytes" = "Bryophytes",
    "Vascular Plants",
    "Fungi & Lichen" = "Fungi and lichens",
    "Worms" = "Worms",
    "Molluscs" = "Molluscs",
    "Crustaceans" = "Crustaceans",
    "Myriapods" = "Myriapods",
    "Insects & Arachnids" = "Insects and arachnids",
    "Fish" = "Fishes",
    "Reptiles & Amphibians" = "Reptiles and amphibians",
    "Birds" = "Birds",
    "Mammals" = "Mammals"
  )
)
```

### Data Restriction

```{r restriction}
selectInput(
  "restriction",
  NULL,
  c(
    "All Data" = "NULL",
    "Restricted Only" = "true",
    "Unrestricted Only" = "false"
  )
)
```

Column {data-width=250}
--------------------------------------------------------------------------------

### Records

```{r fb_record_count}
record_count <-
  reactive({

    req_url_path(req, "record-count") |>
    req_url_query(
      restriction = input$restriction,
      taxa = input$taxa, 
      source = input$source
    ) |>
    req_perform() |>
    resp_body_raw() |>
    unserialize()

  }) |>
  bindEvent(input$restriction, input$taxa, input$source)

renderValueBox({

  valueBox(record_count(), icon = "fa-pen", color = "#1F74AD")

})
```

### Species

```{r fb_species_count}
species_count <-
  reactive({

    req_url_path(req, "species-count") |>
    req_url_query(
      restriction = input$restriction,
      taxa = input$taxa, 
      source = input$source
    ) |>
    req_perform() |>
    resp_body_raw() |>
    unserialize()

  }) |>
  bindEvent(input$restriction, input$taxa, input$source)

renderValueBox({
  valueBox(species_count(), icon = "fa-dove", color = "#1F74AD")

})
```

### Datasets

```{r fb_collection_count}
collection_count <-
  reactive({

    req_url_path(req, "collection-count") |>
    req_url_query(
      restriction = input$restriction,
      taxa = input$taxa, 
      source = input$source
    ) |>
    req_perform() |>
    resp_body_raw() |>
    unserialize()

  }) |>
  bindEvent(input$restriction, input$taxa, input$source)

renderValueBox({

  valueBox(collection_count(), icon = "fa-database", color = "#1F74AD")

})
```

### Dataset Quality Level
</br>
```{r professional}
selectInput(
  "collection_quality",
  NULL,
  c(
    "All Levels" = "NULL",
    "Professionals" = "professional",
    "Specialists" = "hobbyist",
    "Citizen Scientists" = "amateur"
  )
)

quality_table <-
  reactive({

    req_url_path(req, "quality-table") |>
    req_url_query(
      collection_quality = input$collection_quality,
      restriction = input$restriction,
      taxa = input$taxa, 
      source = input$source
    ) |>
    req_perform() |>
    resp_body_raw() |>
    unserialize()

  }) %>%
  bindEvent(
    input$collection_quality, input$restriction, input$taxa, input$source
  )

renderDataTable({
  datatable(
    quality_table(),
    rownames = FALSE,
    options = list(
      bPaginate = FALSE, searching = FALSE, info = FALSE, ordering = FALSE
    ),
    fillContainer = TRUE
  )
})
```

Column {data-width=600 .tabset .tabset-fade}
--------------------------------------------------------------------------------

### Occurrences

```{r occurrence-data}
occurrence_plot <-
  reactive({

    req_url_path(req, "occurrence-plot") |>
    req_url_query(
      restriction = input$restriction,
      taxa = input$taxa, 
      source = input$source
    ) |>
    req_perform() |>
    resp_body_raw() |>
    unserialize()

  }) %>%
  bindEvent(input$restriction, input$taxa, input$source)

renderPlotly({

  ggplotly(occurrence_plot())

})
```

### Annotations

```{r annotations}
annotations_plot <-
  reactive({

    req_url_path(req, "annotations-plot") |>
    req_url_query(
      restriction = input$restriction,
      taxa = input$taxa, 
      source = input$source
    ) |>
    req_perform() |>
    resp_body_raw() |>
    unserialize()
    
  }) %>%
  bindEvent(input$restriction, input$taxa, input$source)

renderPlotly({

  ggplotly(annotations_plot())

})
```

Users
================================================================================

Column {data-width=600 .tabset}
--------------------------------------------------------------------------------

Column {data-width=400}
--------------------------------------------------------------------------------
