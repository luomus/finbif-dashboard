---
title: "LAJI.FI"
output: 
  flexdashboard::flex_dashboard:
    theme:
      version: 4
      fg: "#FDF7F7"
      bg: "#2C3E50"
      primary: "#1F74AD"
      base_font:
        google: Roboto
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{js, echo = FALSE}
document.querySelector(".navbar-header").innerHTML =
  '<a href="https://laji.fi" class="navbar-brand">LAJI.FI</a>'
```

```{r setup, include = FALSE}
library(flexdashboard)
library(finbif)
library(ggplot2)
library(plotly)
library(scales)
library(dplyr)
library(tidyr)
library(janitor)
library(lubridate)
library(DT)
library(thematic)
library(future)
library(promises)

plan(multisession, workers = 4L)

thematic_shiny(
  font = "Roboto", fg = "#FDF7F7", bg = "#2C3E50", accent = "#1F74AD"
)

options(
  finbif_use_cache = 0.05,
  finbif_cache_offset = .5,
  finbif_cache_path = "cache",
  finbif_hide_progress = TRUE,
  finbif_rate_limit = Inf,
  finbif_max_page_size = 3000L,
  finbif_use_async = FALSE
)

if (Sys.getenv("BRANCH") != "main") {

  options(finbif_api_url = "https://apitest.laji.fi")

}

op <- options()

sanitise <- function(x) {

  switch(x, `NULL` = NULL, x)

}

base_filter <- list(
  quality_issues = "both",
  record_reliability = c(
    "reliable",
    "unassessed",
    "unreliable"
  ),
  record_quality = c(
    "expert_verified",
    "community_verified",
    "unassessed",
    "uncertain",
    "erroneous"
  )
)
```

Occurrence Data
================================================================================

Column {data-width=150}
--------------------------------------------------------------------------------

### Data Sources

```{r sources}
selectInput(
  "source",
  NULL,
  c(
    "All Sources" = "NULL",
    "FinBIF" = "HR.1989",
    "Iisalmi Museum" = "HR.4911",
    "Kieppi, Kokkola Museum" = "HR.121",
    "Kuopio Museum" = "HR.1127",
    "Luke" = "HR.1915",
    "Luomus" = "HR.128",
    "Metsähallitus" = "HR.3551",
    "Porvoo Museum" = "HR.4171",
    "SYKE" = "HR.3552",
    "Tampere Museum" = "HR.3811",
    "University of Jyväskylä " = "HR.1247",
    "University of Oulu" = "HR.1207",
    "University of Turku" = "HR.1627"
  )
)
```

### Taxa

```{r taxa}
selectInput(
  "taxa",
  NULL,
  c(
    "All Taxa" = "NULL",
    "Algae" = "Algae",
    "Bryophytes" = "Bryophytes",
    "Vascular Plants",
    "Fungi & Lichen" = "Fungi and lichens",
    "Worms" = "Worms",
    "Molluscs" = "Molluscs",
    "Crustaceans" = "Crustaceans",
    "Myriapods" = "Myriapods",
    "Insects & Arachnids" = "Insects and arachnids",
    "Fish" = "Fishes",
    "Reptiles & Amphibians" = "Reptiles and amphibians",
    "Birds" = "Birds",
    "Mammals" = "Mammals"
  )
)
```

### Data Restriction

```{r restriction}
selectInput(
  "restriction",
  NULL,
  c(
    "All Data" = "NULL",
    "Restricted Only" = "true",
    "Unrestricted Only" = "false"
  )
)
```

Column {data-width=250}
--------------------------------------------------------------------------------

### Records

```{r fb_record_count}
record_count <-
  reactive({

    record_count_filter <- c(
      base_filter,
      list(
        restricted = sanitise(input$restriction),
        informal_groups = sanitise(input$taxa),
        collection = sanitise(input$source)
      )
    )

    future_promise(
      {

        options(op)

        fb_occurrence(
          filter = record_count_filter,
          select = "record_id",
          count_only = TRUE
        )

      },
      seed = TRUE
    )

  }) %>%
  bindEvent(input$restriction, input$taxa, input$source)

renderValueBox({

  record_count() %...>%
  valueBox(icon = "fa-pen", color = "#1F74AD")

})
```

### Species

```{r fb_species_count}
species_count <-
  reactive({

    species_count_filter <- c(
      base_filter,
      list(
        restricted = sanitise(input$restriction),
        informal_groups = sanitise(input$taxa),
        collection = sanitise(input$source)
      )
    )

    future_promise(
      {

        options(op)

        fb_occurrence(
          filter = species_count_filter, 
          select = "species_scientific_name",
          aggregate = "records",
          count_only = TRUE
        )

      },
      seed = TRUE
    )

  }) %>%
  bindEvent(input$restriction, input$taxa, input$source)

renderValueBox({

  species_count() %...>%
  valueBox(icon = "fa-pen", color = "#1F74AD")

})
```

### Datasets

```{r fb_collection_count}
collection_count <-
  reactive({

    collection_count_filter <- c(
      base_filter,
      list(
        restricted = sanitise(input$restriction),
        informal_groups = sanitise(input$taxa),
        collection = sanitise(input$source)
      )
    )

    future_promise(
      {

        options(op)

        fb_occurrence(
          filter = collection_count_filter,
          select = "collection_id",
          aggregate = "records",
          count_only = TRUE
        )

      },
      seed = TRUE
    )

  }) %>%
  bindEvent(input$restriction, input$taxa, input$source)

renderValueBox({

  collection_count() %...>%
  valueBox(icon = "fa-pen", color = "#1F74AD")

})
```

### Collection Quality
</br>
```{r professional}
selectInput(
  "collection_quality",
  NULL,
  c(
    "All" = "NULL",
    "Professionals" = "professional",
    "Specialists" = "hobbyist",
    "Citizen Scientists" = "amateur"
  )
)

quality_table <-
  reactive({

    quality_table_filter <- c(
      base_filter,
      list(
        collection_quality = sanitise(input$collection_quality),
        restricted = sanitise(input$restriction),
        informal_groups = sanitise(input$taxa),
        collection = sanitise(input$source)
      )
    )

    future_promise(
      {

        options(op)

        fb_occurrence(
          filter = quality_table_filter,
          select = c(Quality = "record_quality"),
          aggregate = "records",
          n = "all"
        ) %>%
        mutate(record_quality = replace_na(Quality, "Unnassesed")) %>%
        group_by(Quality) %>%
        summarise(n_records = sum(n_records), .groups = "drop") %>%
        rename(Count = n_records) %>%
        mutate(
          Quality = factor(
            Quality,
            levels = c(
              "Expert verified",
              "Community verified",
              "Unassessed", 
              "Uncertain",
              "Erroneous"
            ),
            ordered = TRUE
          )
        ) %>%
        arrange(Quality) %>%
        adorn_totals()

      },
      seed = TRUE
    )

  }) %>%
  bindEvent(
    input$collection_quality, input$restriction, input$taxa, input$source
  )

renderDataTable({

  quality_table() %...>%
  datatable(
    rownames = FALSE,
    options = list(bPaginate = FALSE, searching = FALSE, info = FALSE),
    fillContainer = TRUE
  )

})
```

Column {data-width=600 .tabset .tabset-fade}
--------------------------------------------------------------------------------

### Occurrences

```{r occurrence-data}
occurrence_plot <-
  reactive({

    occurrence_filter <- c(
      base_filter,
      list(
        restricted = sanitise(input$restriction),
        informal_groups = sanitise(input$taxa),
        collection = sanitise(input$source)
      )
    )

    future_promise(
      {

        options(op)

        fb_occurrence(
          filter = occurrence_filter,
          select = "first_load_date",
          aggregate = "records",
          n = "all"
        ) %>%
        arrange(first_load_date) %>%
        mutate(
          Date = as.Date(first_load_date), Records = cumsum(n_records)
        ) %>%
        ggplot() +
        aes(x = Date, y = Records) +
        geom_line() +
        scale_y_continuous(label = comma) +
        labs(x = NULL, y = "Records")

      },
      seed = TRUE
    )

  }) %>%
  bindEvent(input$restriction, input$taxa, input$source)

renderPlotly({

  occurrence_plot() %...>%
  ggplotly

})
```

### Annotations

```{r annotations}
annotations_plot <-
  reactive({

    annotations_filter <- c(
      base_filter,
      list(
        annotated = TRUE,
        restricted = sanitise(input$restriction),
        informal_groups = sanitise(input$taxa),
        collection = sanitise(input$source)
      )
    )

    future_promise(
      {

        options(op)

        n <- 500

        n_annotations <- fb_occurrence(
          filter = annotations_filter,
          select = "record_annotation_created",
          sample = TRUE,
          n = n
        )

        Date <- n_annotations[["record_annotation_created"]]
        Date <- unlist(Date)
        Date <- sort(Date)
        Date <- as_datetime(Date)
        Date <- as.Date(Date)

        total_annotations <- attr(n_annotations, "nrec_avl")

        Annotations <- length(Date)

        mult <- total_annotations / n

        Annotations <- seq_len(Annotations)

        Annotations <- as.integer(Annotations * mult)

        ggplot() +
         aes(x = Date, y = Annotations) +
         geom_line() +
         scale_y_continuous(label = comma) +
         labs(x = NULL, y = "Annotations")

      },
      seed = TRUE
    )

  }) %>%
  bindEvent(input$restriction, input$taxa, input$source)

renderPlotly({

  annotations_plot() %...>%
  ggplotly

})
```

Users
================================================================================

Column {data-width=600 .tabset}
--------------------------------------------------------------------------------

Column {data-width=400}
--------------------------------------------------------------------------------
